<!--
  ========================================================================
  WEBFLOW STORY FORM EMBED CODE
  ========================================================================

  Copy this entire code block into a Webflow Embed element INSIDE your form.

  IMPORTANT: This embed must be placed INSIDE the Webflow form element,
  not outside it. The hidden inputs need to be children of the form for
  jQuery's $form.serialize() to capture them.

  FIELD MAPPING (Hidden Input Name â†’ Xano Field â†’ Webflow CMS Field):
  ----------------------------------------------------------------
  story_name        â†’ story_name       â†’ name
  author_name       â†’ author_name      â†’ author-name
  story_email       â†’ story_email      â†’ (internal)
  story_input       â†’ story_input      â†’ excerpt
  category          â†’ category         â†’ category
  body_html         â†’ story_content_html â†’ story-content
  uploadcare_url    â†’ uploadcare_url   â†’ featured-image
  author_photo      â†’ author_photo     â†’ author-image
  document_url      â†’ document_url     â†’ document-file

  ========================================================================
-->

<style>
  /* ========== TIPTAP EDITOR STYLES ========== */
  .tiptap-wrapper {
    border: 1px solid #ccc;
    border-radius: 6px;
    overflow: hidden;
    background-color: #fff;
    margin: 20px 0;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  }

  .tiptap-toolbar {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 6px;
    padding: 10px;
    border-bottom: 1px solid #e0e0e0;
    background-color: #f8f8f8;
  }

  .tiptap-toolbar button {
    padding: 6px 12px;
    border: 1px solid #d0d0d0;
    border-radius: 4px;
    background-color: #fff;
    cursor: pointer;
    font-size: 14px;
    line-height: 1.4;
    transition: all 0.2s ease;
    font-weight: 500;
    color: #000;
  }

  .tiptap-toolbar button:hover {
    background-color: #e8e8e8;
    border-color: #b0b0b0;
  }

  .tiptap-toolbar button.is-active {
    background-color: #333;
    color: #fff;
    border-color: #333;
  }

  .tiptap-toolbar button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .tiptap-toolbar .separator {
    width: 1px;
    height: 24px;
    background-color: #d0d0d0;
    margin: 0 4px;
  }

  .tiptap-editor-content {
    padding: 16px;
    min-height: 300px;
    max-height: 600px;
    overflow-y: auto;
    outline: none;
    line-height: 1.6;
    font-size: 16px;
    color: #000 !important;
  }

  .tiptap-editor-content:focus {
    outline: none;
  }

  .tiptap-editor-content * {
    color: #000 !important;
  }

  .tiptap-editor-content a {
    color: #0066cc !important;
  }

  .tiptap-editor-content pre,
  .tiptap-editor-content pre * {
    color: #f8f8f2 !important;
  }

  .tiptap-editor-content .ProseMirror > p.is-editor-empty:first-child::before {
    color: #aaa !important;
    content: attr(data-placeholder);
    float: left;
    height: 0;
    pointer-events: none;
  }

  /* Paragraphs */
  .tiptap-editor-content p {
    margin: 0 0 12px 0;
    color: #000 !important;
    font-size: 16px;
    line-height: 1.7;
  }

  .tiptap-editor-content p:last-child {
    margin-bottom: 0;
  }

  /* Headings */
  .tiptap-editor-content h1,
  .tiptap-editor-content h2,
  .tiptap-editor-content h3,
  .tiptap-editor-content h4,
  .tiptap-editor-content h5,
  .tiptap-editor-content h6 {
    margin: 24px 0 12px 0;
    font-weight: 600;
    line-height: 1.3;
    color: #000 !important;
  }

  .tiptap-editor-content h1:first-child,
  .tiptap-editor-content h2:first-child,
  .tiptap-editor-content h3:first-child {
    margin-top: 0;
  }

  .tiptap-editor-content h1 { font-size: 2em; }
  .tiptap-editor-content h2 { font-size: 1.5em; }
  .tiptap-editor-content h3 { font-size: 1.25em; }
  .tiptap-editor-content h4 { font-size: 1.1em; }
  .tiptap-editor-content h5 { font-size: 1em; }
  .tiptap-editor-content h6 { font-size: 0.9em; }

  /* Lists */
  .tiptap-editor-content ul,
  .tiptap-editor-content ol {
    padding-left: 24px;
    margin: 12px 0;
    color: #000 !important;
  }

  .tiptap-editor-content li {
    margin: 4px 0;
    color: #000 !important;
  }

  /* Blockquote */
  .tiptap-editor-content blockquote {
    border-left: 4px solid #991b1b;
    padding-left: 16px;
    margin: 16px 0;
    color: #333 !important;
    font-style: italic;
  }

  /* Code */
  .tiptap-editor-content code {
    background-color: #f4f4f4;
    padding: 2px 6px;
    border-radius: 3px;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
    color: #000 !important;
  }

  .tiptap-editor-content pre {
    background-color: #2d2d2d;
    color: #f8f8f2 !important;
    padding: 16px;
    border-radius: 6px;
    overflow-x: auto;
    margin: 16px 0;
  }

  .tiptap-editor-content pre code {
    background: none;
    padding: 0;
    color: #f8f8f2 !important;
    font-size: 0.9em;
  }

  /* Links */
  .tiptap-editor-content a {
    color: #991b1b !important;
    text-decoration: underline;
  }

  /* Images */
  .tiptap-editor-content img {
    max-width: 100%;
    height: auto;
    border-radius: 6px;
    margin: 16px 0;
    display: block;
  }

  .tiptap-editor-content strong { font-weight: 600; }

  .tiptap-loading {
    text-align: center;
    padding: 40px;
    color: #999;
  }

  .tiptap-editor-content .ProseMirror {
    color: #000 !important;
  }

  /* ========== IMAGE UPLOAD STYLES ========== */
  .story-image-field {
    margin: 16px 0;
  }

  .story-image-field label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    font-size: 15px;
  }

  .image-upload-container {
    display: flex;
    align-items: center;
    gap: 16px;
    flex-wrap: wrap;
  }

  .image-upload-btn {
    padding: 10px 20px;
    background-color: #000;
    color: #fff;
    border: none;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: background-color 0.2s;
  }

  .image-upload-btn:hover {
    background-color: #333;
  }

  .image-preview {
    display: none;
    align-items: center;
    gap: 12px;
  }

  .image-preview.has-image {
    display: flex;
  }

  .image-preview img {
    width: 80px;
    height: 60px;
    object-fit: cover;
    border-radius: 4px;
    border: 1px solid #ddd;
  }

  .image-preview.avatar img {
    width: 50px;
    height: 50px;
    border-radius: 50%;
  }

  .image-preview .image-name {
    font-size: 13px;
    color: #666;
    max-width: 200px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .image-preview .remove-image {
    padding: 4px 8px;
    background: #fee2e2;
    color: #991b1b;
    border: none;
    cursor: pointer;
    font-size: 12px;
    border-radius: 4px;
  }

  .image-preview .remove-image:hover {
    background: #fecaca;
  }

  /* ========== UPLOADCARE BUTTON STYLES ========== */
  .uploadcare--widget__button,
  .uploadcare--button,
  .uploadcare--button_primary {
    background-color: #000 !important;
    color: #fff !important;
    border-radius: 0 !important;
    border: none !important;
  }

  .uploadcare--widget__button:hover,
  .uploadcare--button:hover,
  .uploadcare--button_primary:hover {
    background-color: #333 !important;
  }

  /* ========== HIDE WEBFLOW NATIVE FILE UPLOAD BUTTONS ========== */
  /* Hide Webflow's default file upload elements to avoid duplicates */
  .w-file-upload,
  .w-file-upload-default,
  .w-file-upload-uploading,
  .w-file-upload-success,
  .w-file-upload-error,
  .w-file-upload-input,
  .w-file-upload-label,
  input[type="file"].w-input,
  input[type="file"],
  label[for*="file"],
  [data-name="upload documents"] .w-file-upload,
  [data-name="upload-documents"] .w-file-upload,
  .w-form input[type="file"],
  .w-button[data-wait],
  div[class*="file-upload"],
  button:contains("Choose an image"),
  label:contains("Choose an image") {
    display: none !important;
  }

  /* Hide any element containing "Choose an image" text */
  .w-file-upload-default-btn,
  .w-file-upload-btn {
    display: none !important;
  }
</style>

<!-- ========== FEATURED IMAGE UPLOAD ========== -->
<!-- NOTE: Remove any Webflow native file upload fields from your form to avoid duplicates -->
<div class="story-image-field" id="story-featured-image-field" style="margin-bottom: 20px;">
  <label style="display: block; margin-bottom: 8px; font-weight: 600;">Featured Image</label>
  <div class="image-upload-container">
    <button type="button" class="image-upload-btn" id="story-featured-image-btn">Upload Featured Image</button>
    <div class="image-preview" id="story-featured-image-preview">
      <img src="" alt="Preview" id="story-featured-image-thumb">
      <span class="image-name" id="story-featured-image-name"></span>
      <button type="button" class="remove-image" id="story-featured-image-remove">Remove</button>
    </div>
  </div>
  <!-- Hidden input with Xano field name -->
  <input type="hidden" id="uploadcare_url" name="uploadcare_url">
</div>

<!-- ========== TIPTAP RICH TEXT EDITOR ========== -->
<div class="tiptap-wrapper" id="story-editor-wrapper">
  <div class="tiptap-toolbar" id="tiptap-toolbar">
    <button type="button" data-action="bold" title="Bold (Ctrl+B)"><strong>B</strong></button>
    <button type="button" data-action="italic" title="Italic (Ctrl+I)"><em>I</em></button>
    <button type="button" data-action="underline" title="Underline (Ctrl+U)"><u>U</u></button>
    <button type="button" data-action="strike" title="Strikethrough"><s>S</s></button>

    <div class="separator"></div>

    <button type="button" data-action="paragraph" title="Paragraph">P</button>
    <button type="button" data-action="h1" title="Heading 1">H1</button>
    <button type="button" data-action="h2" title="Heading 2">H2</button>
    <button type="button" data-action="h3" title="Heading 3">H3</button>
    <button type="button" data-action="h4" title="Heading 4">H4</button>
    <button type="button" data-action="h5" title="Heading 5">H5</button>
    <button type="button" data-action="h6" title="Heading 6">H6</button>

    <div class="separator"></div>

    <button type="button" data-action="bulletList" title="Bullet List">List</button>
    <button type="button" data-action="orderedList" title="Numbered List">1. List</button>
    <button type="button" data-action="blockquote" title="Quote">Quote</button>
    <button type="button" data-action="codeBlock" title="Code Block">Code</button>

    <div class="separator"></div>

    <button type="button" data-action="link" title="Insert Link">Link</button>
    <button type="button" data-action="upload" title="Insert Image">Image</button>
  </div>

  <div class="tiptap-editor-content" id="tiptap-editor-content">
    <div class="tiptap-loading">Loading editor...</div>
  </div>
</div>

<!-- ========== AUTHOR IMAGE UPLOAD ========== -->
<div class="story-image-field" id="story-author-image-field" style="margin-bottom: 20px;">
  <label style="display: block; margin-bottom: 8px; font-weight: 600;">Author Photo</label>
  <div class="image-upload-container">
    <button type="button" class="image-upload-btn" id="story-author-image-btn">Upload Photo</button>
    <div class="image-preview avatar" id="story-author-image-preview">
      <img src="" alt="Preview" id="story-author-image-thumb">
      <span class="image-name" id="story-author-image-name"></span>
      <button type="button" class="remove-image" id="story-author-image-remove">Remove</button>
    </div>
  </div>
  <!-- Hidden input with Xano field name -->
  <input type="hidden" id="author_photo" name="author_photo">
</div>

<!-- ========== DOCUMENT UPLOAD (Word, PPT, PDF) ========== -->
<div class="story-image-field" id="story-document-field" style="margin-bottom: 20px;">
  <label style="display: block; margin-bottom: 8px; font-weight: 600;">Documents for Review</label>
  <div class="image-upload-container">
    <button type="button" class="image-upload-btn" id="story-document-btn">Upload Documents for Review</button>
    <div class="image-preview" id="story-document-preview" style="display: none;">
      <span class="doc-icon" style="font-size: 24px;">ðŸ“„</span>
      <span class="image-name" id="story-document-name"></span>
      <button type="button" class="remove-image" id="story-document-remove">Remove</button>
    </div>
  </div>
  <small style="color: #fff; display: block; margin-top: 6px;">Accepted: PDF, Word (.doc, .docx), PowerPoint (.ppt, .pptx)</small>
  <input type="hidden" id="story_document_url" name="document_url">
</div>

<!-- Hidden inputs for Tiptap content -->
<input type="hidden" id="body_html" name="body_html">
<input type="hidden" id="body_text" name="body_text">

<!-- ========== UPLOADCARE WIDGET ========== -->
<script>
  UPLOADCARE_PUBLIC_KEY = 'b3ab69f1399f85fd8f43';
  UPLOADCARE_TABS = 'file url camera dropbox gdrive';
  UPLOADCARE_IMAGES_ONLY = true;
  UPLOADCARE_LOCALE = 'en';
  UPLOADCARE_PREVIEW_STEP = true;
  UPLOADCARE_CLEARABLE = true;
  UPLOADCARE_MULTIPLE = false;
</script>
<script src="https://ucarecdn.com/libs/widget/3.x/uploadcare.full.min.js"></script>

<!-- ========== TIPTAP + FORM HANDLER SCRIPT ========== -->
<script type="module">
import { Editor } from 'https://esm.sh/@tiptap/core@2.1.13';
import StarterKit from 'https://esm.sh/@tiptap/starter-kit@2.1.13';
import Underline from 'https://esm.sh/@tiptap/extension-underline@2.1.13';
import Link from 'https://esm.sh/@tiptap/extension-link@2.1.13';
import Image from 'https://esm.sh/@tiptap/extension-image@2.1.13';
import Placeholder from 'https://esm.sh/@tiptap/extension-placeholder@2.1.13';

// ============================================================================
// CONFIGURATION - Matches your Xano endpoint
// ============================================================================
const CONFIG = {
  // Xano stories endpoint (same as stories.html form)
  xanoEndpoint: 'https://xerb-qpd6-hd8t.n7.xano.io/api:pIN2vLYu/stories',

  // Webflow form selector - UPDATE THIS to match your Webflow form ID
  formSelector: '[data-name="Story Form"], #wf-form-Story-Form, form[name="wf-form-Story-Form"]',

  // Required fields for validation
  requiredFields: ['title', 'author_name', 'author_email'],

  // Uploadcare public key
  uploadcareKey: 'b3ab69f1399f85fd8f43',

  // Editor placeholder text
  placeholderText: 'Start writing your story here...',

  // Enable auto-sync to Webflow CMS
  syncToWebflow: true
};

let editor = null;

// ============================================================================
// UPLOADCARE IMAGE UPLOADERS
// ============================================================================

function setupImageUploaders() {
  // Featured Image Upload - inputId matches Xano field name
  setupImageUploader({
    buttonId: 'story-featured-image-btn',
    previewId: 'story-featured-image-preview',
    thumbId: 'story-featured-image-thumb',
    nameId: 'story-featured-image-name',
    removeId: 'story-featured-image-remove',
    inputId: 'uploadcare_url',  // Xano field: uploadcare_url
    buttonTextDefault: 'Upload Featured Image',
    buttonTextChange: 'Change Featured Image',
    crop: '16:9'
  });

  // Author Image Upload - inputId matches Xano field name
  setupImageUploader({
    buttonId: 'story-author-image-btn',
    previewId: 'story-author-image-preview',
    thumbId: 'story-author-image-thumb',
    nameId: 'story-author-image-name',
    removeId: 'story-author-image-remove',
    inputId: 'author_photo',  // Xano field: author_photo
    buttonTextDefault: 'Upload Photo',
    buttonTextChange: 'Change Photo',
    crop: '1:1'
  });

  // Document Upload (Word, PPT, PDF)
  setupDocumentUploader({
    buttonId: 'story-document-btn',
    previewId: 'story-document-preview',
    nameId: 'story-document-name',
    removeId: 'story-document-remove',
    inputId: 'story_document_url',
    buttonTextDefault: 'Upload Document',
    buttonTextChange: 'Change Document'
  });
}

// Document uploader (allows non-image files)
function setupDocumentUploader(config) {
  const btn = document.getElementById(config.buttonId);
  const preview = document.getElementById(config.previewId);
  const nameEl = document.getElementById(config.nameId);
  const removeBtn = document.getElementById(config.removeId);
  const input = document.getElementById(config.inputId);

  if (!btn) return;

  btn.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();

    if (typeof uploadcare === 'undefined') {
      alert('Upload not available. Please refresh the page.');
      return;
    }

    const dialog = uploadcare.openDialog(null, {
      publicKey: CONFIG.uploadcareKey,
      imagesOnly: false, // Allow all file types
      tabs: 'file url dropbox gdrive',
      multiple: false,
      previewStep: true,
      inputAcceptTypes: '.pdf,.doc,.docx,.ppt,.pptx,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.presentation'
    });

    dialog.done((file) => {
      file.promise().done((fileInfo) => {
        console.log(`Uploaded document:`, fileInfo.cdnUrl, fileInfo.name);

        if (input) input.value = fileInfo.cdnUrl;
        if (nameEl) nameEl.textContent = fileInfo.name || 'Document uploaded';
        if (preview) {
          preview.style.display = 'flex';
          preview.classList.add('has-image');
        }
        btn.textContent = config.buttonTextChange;
      });
    });
  });

  if (removeBtn) {
    removeBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();

      if (input) input.value = '';
      if (nameEl) nameEl.textContent = '';
      if (preview) {
        preview.style.display = 'none';
        preview.classList.remove('has-image');
      }
      btn.textContent = config.buttonTextDefault;
    });
  }
}

function setupImageUploader(config) {
  const btn = document.getElementById(config.buttonId);
  const preview = document.getElementById(config.previewId);
  const thumb = document.getElementById(config.thumbId);
  const nameEl = document.getElementById(config.nameId);
  const removeBtn = document.getElementById(config.removeId);
  const input = document.getElementById(config.inputId);

  if (!btn) return;

  btn.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();

    if (typeof uploadcare === 'undefined') {
      alert('Upload not available. Please refresh the page.');
      return;
    }

    const dialog = uploadcare.openDialog(null, {
      publicKey: CONFIG.uploadcareKey,
      imagesOnly: true,
      tabs: 'file url camera',
      multiple: false,
      previewStep: true,
      crop: config.crop || false
    });

    dialog.done((file) => {
      file.promise().done((fileInfo) => {
        console.log(`=== Uploadcare Image Upload Complete ===`);
        console.log(`  Input ID: ${config.inputId}`);
        console.log(`  CDN URL: ${fileInfo.cdnUrl}`);
        console.log(`  File name: ${fileInfo.name}`);

        if (input) {
          input.value = fileInfo.cdnUrl;
          console.log(`  Hidden input value set: ${input.value}`);
        } else {
          console.error(`  ERROR: Hidden input #${config.inputId} not found!`);
        }

        if (thumb) thumb.src = fileInfo.cdnUrl;
        if (nameEl) nameEl.textContent = fileInfo.name || 'Image uploaded';
        if (preview) preview.classList.add('has-image');
        btn.textContent = config.buttonTextChange;
      });
    });
  });

  if (removeBtn) {
    removeBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();

      if (input) input.value = '';
      if (thumb) thumb.src = '';
      if (nameEl) nameEl.textContent = '';
      if (preview) preview.classList.remove('has-image');
      btn.textContent = config.buttonTextDefault;
    });
  }
}

// ============================================================================
// TIPTAP EDITOR
// ============================================================================

function initTiptapEditor() {
  const editorElement = document.getElementById('tiptap-editor-content');
  if (!editorElement) {
    console.error('Tiptap editor element not found');
    return;
  }

  editorElement.innerHTML = '';

  try {
    editor = new Editor({
      element: editorElement,
      extensions: [
        StarterKit.configure({
          heading: { levels: [1, 2, 3, 4, 5, 6] }
        }),
        Underline,
        Link.configure({
          openOnClick: false,
          autolink: true,
          HTMLAttributes: {
            target: '_blank',
            rel: 'noopener noreferrer'
          }
        }),
        Image.configure({
          inline: false,
          allowBase64: false,
          HTMLAttributes: { class: 'editor-image' }
        }),
        Placeholder.configure({
          placeholder: CONFIG.placeholderText
        })
      ],
      editorProps: {
        attributes: { style: 'color: #000 !important;' }
      },
      onUpdate: ({ editor }) => {
        const htmlInput = document.getElementById('body_html');
        const textInput = document.getElementById('body_text');

        if (htmlInput) htmlInput.value = editor.getHTML();
        if (textInput) textInput.value = editor.getText();
      },
      onCreate: ({ editor }) => {
        console.log('Tiptap editor initialized');
        window.tiptapEditor = editor;
      }
    });

    setupToolbar();

  } catch (error) {
    console.error('Error initializing Tiptap:', error);
    editorElement.innerHTML = '<div class="tiptap-loading" style="color: red;">Error loading editor. Please refresh.</div>';
  }
}

function setupToolbar() {
  const toolbar = document.getElementById('tiptap-toolbar');
  if (!toolbar || !editor) return;

  const actions = {
    bold: () => editor.chain().focus().toggleBold().run(),
    italic: () => editor.chain().focus().toggleItalic().run(),
    underline: () => editor.chain().focus().toggleUnderline().run(),
    strike: () => editor.chain().focus().toggleStrike().run(),
    paragraph: () => editor.chain().focus().setParagraph().run(),
    h1: () => editor.chain().focus().toggleHeading({ level: 1 }).run(),
    h2: () => editor.chain().focus().toggleHeading({ level: 2 }).run(),
    h3: () => editor.chain().focus().toggleHeading({ level: 3 }).run(),
    h4: () => editor.chain().focus().toggleHeading({ level: 4 }).run(),
    h5: () => editor.chain().focus().toggleHeading({ level: 5 }).run(),
    h6: () => editor.chain().focus().toggleHeading({ level: 6 }).run(),
    bulletList: () => editor.chain().focus().toggleBulletList().run(),
    orderedList: () => editor.chain().focus().toggleOrderedList().run(),
    blockquote: () => editor.chain().focus().toggleBlockquote().run(),
    codeBlock: () => editor.chain().focus().toggleCodeBlock().run(),
    link: handleLinkAction,
    upload: handleInlineImageUpload
  };

  toolbar.addEventListener('click', (e) => {
    const button = e.target.closest('button');
    if (!button || !editor) return;

    const action = button.dataset.action;
    if (actions[action]) {
      e.preventDefault();
      e.stopPropagation();
      actions[action]();
      if (action !== 'upload') {
        updateToolbarState();
      }
    }
  });

  editor.on('transaction', updateToolbarState);
  editor.on('selectionUpdate', updateToolbarState);
  updateToolbarState();
}

function updateToolbarState() {
  if (!editor) return;
  const toolbar = document.getElementById('tiptap-toolbar');
  if (!toolbar) return;

  toolbar.querySelectorAll('button').forEach(button => {
    const action = button.dataset.action;
    let isActive = false;

    switch (action) {
      case 'bold': isActive = editor.isActive('bold'); break;
      case 'italic': isActive = editor.isActive('italic'); break;
      case 'underline': isActive = editor.isActive('underline'); break;
      case 'strike': isActive = editor.isActive('strike'); break;
      case 'paragraph': isActive = editor.isActive('paragraph'); break;
      case 'h1': isActive = editor.isActive('heading', { level: 1 }); break;
      case 'h2': isActive = editor.isActive('heading', { level: 2 }); break;
      case 'h3': isActive = editor.isActive('heading', { level: 3 }); break;
      case 'h4': isActive = editor.isActive('heading', { level: 4 }); break;
      case 'h5': isActive = editor.isActive('heading', { level: 5 }); break;
      case 'h6': isActive = editor.isActive('heading', { level: 6 }); break;
      case 'bulletList': isActive = editor.isActive('bulletList'); break;
      case 'orderedList': isActive = editor.isActive('orderedList'); break;
      case 'blockquote': isActive = editor.isActive('blockquote'); break;
      case 'codeBlock': isActive = editor.isActive('codeBlock'); break;
      case 'link': isActive = editor.isActive('link'); break;
    }

    button.classList.toggle('is-active', isActive);
  });
}

function handleLinkAction() {
  if (!editor) return;
  const previousUrl = editor.getAttributes('link').href;
  const url = window.prompt('Enter URL (leave empty to remove):', previousUrl || 'https://');

  if (url === null) return;
  if (url === '') {
    editor.chain().focus().extendMarkRange('link').unsetLink().run();
  } else {
    editor.chain().focus().extendMarkRange('link').setLink({ href: url }).run();
  }
}

function handleInlineImageUpload() {
  if (!editor || typeof uploadcare === 'undefined') {
    alert('Upload not available. Please refresh.');
    return;
  }

  const dialog = uploadcare.openDialog(null, {
    publicKey: CONFIG.uploadcareKey,
    imagesOnly: true,
    tabs: 'file url camera dropbox gdrive',
    multiple: false,
    previewStep: true
  });

  dialog.done((file) => {
    file.promise().done((fileInfo) => {
      editor.chain().focus().setImage({
        src: fileInfo.cdnUrl,
        alt: fileInfo.name || 'Image'
      }).run();
    });
  });
}

// ============================================================================
// FORM INTEGRATION - Submit to Xano + Auto-sync to Webflow
// ============================================================================

function setupFormHandler() {
  // Try multiple selectors to find the Webflow form
  let form = document.querySelector(CONFIG.formSelector);

  if (!form) {
    const fallbackSelectors = [
      'form[data-name*="story" i]',
      'form[data-name*="Story" i]',
      'form[name*="story" i]',
      'form[id*="story" i]',
      '.w-form form',
      'form'
    ];

    for (const selector of fallbackSelectors) {
      form = document.querySelector(selector);
      if (form) break;
    }
  }

  if (!form) {
    console.error('No form found on page');
    return;
  }

  // Take over form submission entirely
  form.addEventListener('submit', handleFormSubmit);
  console.log('Form handler ready - will submit to Xano and sync to Webflow');
}

async function handleFormSubmit(e) {
  e.preventDefault();
  const form = e.target;
  const submitBtn = form.querySelector('[type="submit"]');
  const originalBtnText = submitBtn?.textContent;

  try {
    // Update button state
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';
    }

    // Build form data
    const formData = buildFormData(form);
    console.log('Submitting story:', formData);

    // Step 1: Submit to Xano
    const storyResponse = await fetch(CONFIG.xanoEndpoint, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(formData)
    });

    const storyResult = await storyResponse.json();
    console.log('Xano response:', storyResult);

    if (!storyResponse.ok || !storyResult.id) {
      throw new Error(storyResult.message || 'Failed to create story');
    }

    const storyId = storyResult.id;
    console.log(`Story created with ID: ${storyId}`);

    // Show success - Webflow sync happens via background job
    showFormSuccess(form, storyId);

  } catch (error) {
    console.error('Form submission error:', error);
    showFormError(form, error.message);
  } finally {
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.textContent = originalBtnText;
    }
  }
}

function buildFormData(form) {
  const data = {};

  // Get standard form fields
  const formData = new FormData(form);
  for (const [key, value] of formData.entries()) {
    if (value && value.trim) {
      data[key] = value.trim();
    }
  }

  // Add Tiptap editor content
  if (editor) {
    data.body_html = editor.getHTML();
    data.body_text = editor.getText();
    data.story_content_html = editor.getHTML();
  }

  // Add image URLs
  const featuredUrl = document.getElementById('uploadcare_url')?.value;
  const authorUrl = document.getElementById('author_photo')?.value;
  const documentUrl = document.getElementById('story_document_url')?.value;

  if (featuredUrl) data.uploadcare_url = featuredUrl;
  if (authorUrl) data.author_photo = authorUrl;
  if (documentUrl) data.document_url = documentUrl;

  // Map common field names to Xano field names
  if (data.title && !data.story_name) data.story_name = data.title;
  if (data.email && !data.story_email) data.story_email = data.email;
  if (data.author_email && !data.story_email) data.story_email = data.author_email;
  if (data.excerpt && !data.story_input) data.story_input = data.excerpt;

  return data;
}

function showFormSuccess(form, storyId) {
  // Hide form
  form.style.display = 'none';

  // Show success message
  const successDiv = form.parentElement.querySelector('.w-form-done') ||
                     document.createElement('div');

  successDiv.className = 'w-form-done';
  successDiv.style.display = 'block';
  successDiv.innerHTML = `
    <div style="text-align: center; padding: 40px 20px; font-size: 1rem; font-weight: normal;">
      <p style="margin-bottom: 8px;">Story Submitted Successfully!</p>
      <p style="margin-bottom: 8px;">Your story has been saved.</p>
      <p>It will appear on the website shortly.</p>
    </div>
  `;

  if (!form.parentElement.querySelector('.w-form-done')) {
    form.parentElement.appendChild(successDiv);
  }
}

function showFormError(form, message) {
  const errorDiv = form.parentElement.querySelector('.w-form-fail') ||
                   document.createElement('div');

  errorDiv.className = 'w-form-fail';
  errorDiv.style.display = 'block';
  errorDiv.innerHTML = `
    <div style="color: #dc2626; padding: 16px;">
      <strong>Error:</strong> ${message}
    </div>
  `;

  if (!form.parentElement.querySelector('.w-form-fail')) {
    form.parentElement.appendChild(errorDiv);
  }
}

// ============================================================================
// INITIALIZE
// ============================================================================

function init() {
  console.log('Initializing Story Form...');

  // Small delay to ensure DOM is ready
  setTimeout(() => {
    initTiptapEditor();
    setupImageUploaders();
    setupFormHandler();
    console.log('Story form ready');
  }, 100);
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
</script>
