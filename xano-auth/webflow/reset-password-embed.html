<!--
  RESET PASSWORD FORM EMBED FOR WEBFLOW

  HOW TO USE:
  1. In Webflow, create an Embed element where you want the form
  2. Copy this entire code block
  3. Paste into the Embed element

  PAGE URL: /reset-password?token=xxx

  The token parameter is required - users arrive here from the email link.

  CUSTOMIZE:
  - Update colors in the <style> section (uses USC cardinal red #8B0000)
  - Change XANO_API_URL below
-->

<div id="reset-password-widget">
  <!-- Reset Form -->
  <form id="reset-form" class="auth-form">
    <div class="form-header">
      <h2>Create New Password</h2>
      <p>Enter your new password below. Choose something secure you haven't used before.</p>
    </div>

    <!-- Error Message -->
    <div id="form-error" class="form-error" style="display: none;">
      <span id="error-message"></span>
    </div>

    <!-- New Password -->
    <div class="form-group">
      <label for="password">New Password</label>
      <div class="password-wrapper">
        <input type="password" id="password" name="password" required placeholder="At least 8 characters" autocomplete="new-password" minlength="8">
        <button type="button" class="toggle-password" aria-label="Show password">
          <span class="eye-icon">&#128065;</span>
        </button>
      </div>
      <div class="password-strength" id="password-strength"></div>
    </div>

    <!-- Confirm Password -->
    <div class="form-group">
      <label for="password_confirm">Confirm Password</label>
      <div class="password-wrapper">
        <input type="password" id="password_confirm" name="password_confirm" required placeholder="Re-enter your password" autocomplete="new-password">
        <button type="button" class="toggle-password" aria-label="Show password">
          <span class="eye-icon">&#128065;</span>
        </button>
      </div>
      <div id="match-indicator" class="match-indicator"></div>
    </div>

    <!-- Submit Button -->
    <button type="submit" id="reset-submit" class="submit-btn" disabled>Reset Password</button>

    <!-- Footer -->
    <div class="form-footer">
      <a href="/login" class="back-link">&larr; Back to login</a>
    </div>
  </form>

  <!-- Loading State -->
  <div id="reset-loading" class="loading-state" style="display: none;">
    <div class="spinner"></div>
    <p>Resetting your password...</p>
  </div>

  <!-- Success State -->
  <div id="reset-success" class="success-state" style="display: none;">
    <div class="success-icon">&#10003;</div>
    <h2>Password Reset Complete</h2>
    <p>Your password has been successfully changed. You can now log in with your new password.</p>
    <a href="/login" class="submit-btn" style="display: inline-block; text-decoration: none; text-align: center;">Continue to Login</a>
  </div>

  <!-- Invalid Token State -->
  <div id="reset-invalid" class="error-state" style="display: none;">
    <div class="error-icon">&#10060;</div>
    <h2>Invalid or Expired Link</h2>
    <p id="invalid-message">This password reset link is no longer valid. It may have expired or already been used.</p>
    <a href="/forgot-password" class="submit-btn" style="display: inline-block; text-decoration: none; text-align: center;">Request New Reset Link</a>
    <div class="form-footer">
      <a href="/login" class="back-link">&larr; Back to login</a>
    </div>
  </div>

  <!-- No Token State -->
  <div id="reset-no-token" class="error-state" style="display: none;">
    <div class="error-icon">&#128274;</div>
    <h2>Missing Reset Token</h2>
    <p>No password reset token was found. Please use the link from your email or request a new reset link.</p>
    <a href="/forgot-password" class="submit-btn" style="display: inline-block; text-decoration: none; text-align: center;">Request Reset Link</a>
    <div class="form-footer">
      <a href="/login" class="back-link">&larr; Back to login</a>
    </div>
  </div>
</div>

<style>
  /* ====================================
     RESET PASSWORD WIDGET STYLES
     ==================================== */

  #reset-password-widget {
    max-width: 420px;
    margin: 0 auto;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
  }

  /* Form Layout */
  .auth-form {
    background: #fff;
    padding: 32px;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  }

  .form-header {
    text-align: center;
    margin-bottom: 28px;
  }

  .form-header h2 {
    font-size: 24px;
    font-weight: 600;
    color: #1f2937;
    margin: 0 0 8px 0;
  }

  .form-header p {
    font-size: 15px;
    color: #6b7280;
    margin: 0;
    line-height: 1.5;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-group label {
    display: block;
    font-size: 14px;
    font-weight: 500;
    color: #374151;
    margin-bottom: 6px;
  }

  .form-group input {
    width: 100%;
    padding: 12px 14px;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    font-size: 15px;
    transition: border-color 0.2s, box-shadow 0.2s;
    box-sizing: border-box;
  }

  .form-group input:focus {
    outline: none;
    border-color: #8B0000;
    box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.1);
  }

  .form-group input::placeholder {
    color: #9ca3af;
  }

  /* Password Wrapper */
  .password-wrapper {
    position: relative;
  }

  .password-wrapper input {
    padding-right: 48px;
  }

  .toggle-password {
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    cursor: pointer;
    padding: 4px;
    color: #6b7280;
    font-size: 18px;
  }

  .toggle-password:hover {
    color: #374151;
  }

  /* Password Strength Indicator */
  .password-strength {
    margin-top: 8px;
    font-size: 13px;
    min-height: 20px;
  }

  .password-strength.weak {
    color: #dc2626;
  }

  .password-strength.fair {
    color: #f59e0b;
  }

  .password-strength.good {
    color: #16a34a;
  }

  .password-strength.strong {
    color: #059669;
  }

  /* Match Indicator */
  .match-indicator {
    margin-top: 8px;
    font-size: 13px;
    min-height: 20px;
  }

  .match-indicator.match {
    color: #16a34a;
  }

  .match-indicator.no-match {
    color: #dc2626;
  }

  /* Submit Button */
  .submit-btn {
    width: 100%;
    padding: 14px 24px;
    background: #8B0000;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
  }

  .submit-btn:hover:not(:disabled) {
    background: #6B0000;
  }

  .submit-btn:disabled {
    background: #9ca3af;
    cursor: not-allowed;
  }

  /* Form Footer */
  .form-footer {
    text-align: center;
    margin-top: 24px;
  }

  .back-link {
    color: #6b7280;
    font-size: 14px;
    text-decoration: none;
    transition: color 0.2s;
  }

  .back-link:hover {
    color: #8B0000;
  }

  /* Error Message */
  .form-error {
    background: #fef2f2;
    border: 1px solid #fecaca;
    color: #dc2626;
    padding: 12px 14px;
    border-radius: 8px;
    margin-bottom: 20px;
    font-size: 14px;
  }

  /* Loading State */
  .loading-state {
    text-align: center;
    padding: 60px 20px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  }

  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid #e5e7eb;
    border-top-color: #8B0000;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 16px;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .loading-state p {
    color: #6b7280;
    font-size: 15px;
    margin: 0;
  }

  /* Success State */
  .success-state {
    text-align: center;
    padding: 40px 32px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  }

  .success-icon {
    width: 64px;
    height: 64px;
    background: #f0fdf4;
    color: #16a34a;
    font-size: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
    border: 2px solid #bbf7d0;
  }

  .success-state h2 {
    color: #166534;
    font-size: 22px;
    margin: 0 0 12px 0;
  }

  .success-state p {
    color: #6b7280;
    font-size: 15px;
    margin: 0 0 24px 0;
    line-height: 1.5;
  }

  /* Error State */
  .error-state {
    text-align: center;
    padding: 40px 32px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  }

  .error-icon {
    width: 64px;
    height: 64px;
    background: #fef2f2;
    color: #dc2626;
    font-size: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 20px;
    border: 2px solid #fecaca;
  }

  .error-state h2 {
    color: #991b1b;
    font-size: 22px;
    margin: 0 0 12px 0;
  }

  .error-state p {
    color: #6b7280;
    font-size: 15px;
    margin: 0 0 24px 0;
    line-height: 1.5;
  }

  /* Shake Animation */
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-8px); }
    75% { transform: translateX(8px); }
  }

  .shake {
    animation: shake 0.3s ease-in-out;
  }

  /* Mobile Responsive */
  @media (max-width: 480px) {
    .auth-form, .success-state, .loading-state, .error-state {
      padding: 24px 20px;
      margin: 0 16px;
    }
  }
</style>

<script>
(function() {
  'use strict';

  // ============================================
  // CONFIGURATION - UPDATE THIS
  // ============================================
  const XANO_API_URL = 'https://xerb-qpd6-hd8t.n7.xano.io/api:hJgoiIwh';
  // ============================================

  const $ = (s) => document.querySelector(s);
  const $$ = (s) => document.querySelectorAll(s);
  const show = (s) => { const el = $(s); if (el) el.style.display = ''; };
  const hide = (s) => { const el = $(s); if (el) el.style.display = 'none'; };

  let resetToken = '';

  // API call
  async function api(endpoint, method, body) {
    const res = await fetch(XANO_API_URL + endpoint, {
      method,
      headers: { 'Content-Type': 'application/json' },
      body: body ? JSON.stringify(body) : null
    });
    const data = await res.json();
    if (!res.ok) {
      const err = new Error(data.message || 'Request failed');
      err.code = data.code;
      throw err;
    }
    return data;
  }

  // Show error
  function showError(msg) {
    $('#error-message').textContent = msg;
    show('#form-error');
    $('#reset-form').classList.add('shake');
    setTimeout(() => $('#reset-form').classList.remove('shake'), 300);
  }

  // Set loading
  function setLoading(loading) {
    const btn = $('#reset-submit');
    if (btn) {
      btn.textContent = loading ? 'Resetting...' : 'Reset Password';
    }
    if (loading) {
      hide('#reset-form');
      show('#reset-loading');
    } else {
      show('#reset-form');
      hide('#reset-loading');
    }
  }

  // Password strength checker
  function checkPasswordStrength(password) {
    const indicator = $('#password-strength');
    if (!indicator) return;

    if (!password) {
      indicator.textContent = '';
      indicator.className = 'password-strength';
      return;
    }

    let strength = 0;
    if (password.length >= 8) strength++;
    if (password.length >= 12) strength++;
    if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
    if (/\d/.test(password)) strength++;
    if (/[^a-zA-Z0-9]/.test(password)) strength++;

    const levels = [
      { class: 'weak', text: 'Weak - Add more characters' },
      { class: 'weak', text: 'Weak - Add numbers or symbols' },
      { class: 'fair', text: 'Fair - Could be stronger' },
      { class: 'good', text: 'Good password' },
      { class: 'strong', text: 'Strong password' }
    ];

    const level = levels[Math.min(strength, levels.length - 1)];
    indicator.textContent = level.text;
    indicator.className = 'password-strength ' + level.class;
  }

  // Check password match
  function checkPasswordMatch() {
    const password = $('#password').value;
    const confirm = $('#password_confirm').value;
    const indicator = $('#match-indicator');
    const submitBtn = $('#reset-submit');

    if (!confirm) {
      indicator.textContent = '';
      indicator.className = 'match-indicator';
      submitBtn.disabled = true;
      return;
    }

    if (password === confirm) {
      indicator.textContent = '‚úì Passwords match';
      indicator.className = 'match-indicator match';
      submitBtn.disabled = password.length < 8;
    } else {
      indicator.textContent = '‚úó Passwords do not match';
      indicator.className = 'match-indicator no-match';
      submitBtn.disabled = true;
    }
  }

  // Toggle password visibility
  function setupPasswordToggles() {
    $$('.toggle-password').forEach(btn => {
      btn.addEventListener('click', function() {
        const wrapper = this.closest('.password-wrapper');
        const input = wrapper.querySelector('input');
        const icon = this.querySelector('.eye-icon');

        if (input.type === 'password') {
          input.type = 'text';
          icon.textContent = 'üôà';
        } else {
          input.type = 'password';
          icon.textContent = 'üëÅ';
        }
      });
    });
  }

  // Handle form submit
  async function handleSubmit(e) {
    e.preventDefault();
    hide('#form-error');

    const password = $('#password').value;
    const passwordConfirm = $('#password_confirm').value;

    // Validate
    if (!password) {
      showError('Password is required');
      return;
    }

    if (password.length < 8) {
      showError('Password must be at least 8 characters');
      return;
    }

    if (password !== passwordConfirm) {
      showError('Passwords do not match');
      return;
    }

    setLoading(true);

    try {
      await api('/auth/reset-password', 'POST', {
        token: resetToken,
        password: password,
        password_confirm: passwordConfirm
      });

      // Success!
      hide('#reset-loading');
      show('#reset-success');

    } catch (err) {
      setLoading(false);

      // Handle specific error codes
      if (err.code === 'INVALID_TOKEN' || err.code === 'TOKEN_EXPIRED') {
        hide('#reset-form');
        $('#invalid-message').textContent = err.message;
        show('#reset-invalid');
      } else {
        showError(err.message || 'Failed to reset password. Please try again.');
      }
    }
  }

  // Init
  function init() {
    // Check if already logged in
    const existingUser = localStorage.getItem('xano_user');
    if (existingUser) {
      window.location.href = '/student/dashboard';
      return;
    }

    // Get token from URL
    const params = new URLSearchParams(window.location.search);
    resetToken = params.get('token');

    // No token? Show error state
    if (!resetToken) {
      hide('#reset-form');
      show('#reset-no-token');
      return;
    }

    // Setup password visibility toggles
    setupPasswordToggles();

    // Password strength checking
    const passwordInput = $('#password');
    if (passwordInput) {
      passwordInput.addEventListener('input', function() {
        checkPasswordStrength(this.value);
        checkPasswordMatch();
      });
    }

    // Password match checking
    const confirmInput = $('#password_confirm');
    if (confirmInput) {
      confirmInput.addEventListener('input', checkPasswordMatch);
    }

    // Form handler
    const form = $('#reset-form');
    if (form) form.addEventListener('submit', handleSubmit);

    // Focus password input
    if (passwordInput) passwordInput.focus();
  }

  // Start
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
